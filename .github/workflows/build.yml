on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: checkout satysfi
      uses: actions/checkout@v3
      with:
        repository: gfngfn/SATySFi
        path: satysfi

    - name: restore last build commit
      uses: actions/download-artifact@v3
      with:
        name: last-commit-id
        path: .
      continue-on-error: true
    
    - name: load last build commit id into environment variable 
      run: test -f "last-commit-id" && export ID=$(cat last-commit-id) && echo "LAST_COMMIT_ID=${ID}" >> $GITHUB_ENV || echo "first build"
    
    - name: load head commit id into environment variable
      run: export ID=$(git rev-parse HEAD) && echo "HEAD_COMMIT_ID=${ID}" >> $GITHUB_ENV
      working-directory: satysfi

    - name: check require update
      run: | 
        if [ -z "$LAST_COMMIT_ID" ] || ( \                                      # last commit id is not exists
          [ "$LAST_COMMIT_ID" != "$HEAD_COMMIT_ID" ] && \                       # or last commit id is not equal to head commit id
          git diff $LAST_COMMIT_ID $HEAD_COMMIT_ID --exit-code --quiet -- doc \ # and there is difference between last commit and head commit
        ); then
          export REQUIRE_UPDATE=true
        else 
          export REQUIRE_UPDATE=false
        fi
        echo "REQUIRE_UPDATE=$REQUIRE_UPDATE"
        echo "REQUIRE_UPDATE=$REQUIRE_UPDATE" >> $GITHUB_ENV
      working-directory: satysfi

    - name: update last commit id
      if: ${{ env.REQUIRE_UPDATE }}
      run: echo '$HEAD_COMMIT_ID' > last-commit-id
      

    - name: save last commit id
      if: ${{ env.REQUIRE_UPDATE }}
      uses: actions/upload-artifact@v3
      with:
        name: last-commit-id
        path: last-commit-id

    - name: build docs
      if: ${{ env.REQUIRE_UPDATE }}
      run: |
        docker run --workdir /satysfi/doc \
                   --mount type=bind,consistency=cached,src=$(pwd)/satysfi,dst=/satysfi \
                   ghcr.io/maemon4095/satysfi:latest "satyrographos install && make"
      
    - name: checkout repository
      if: ${{ env.REQUIRE_UPDATE }}
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        path: repo
    
    - name: commit docs
      if: ${{ env.REQUIRE_UPDATE }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        mv ../satysfi/doc/*.pdf .
        git config user.name "${GITHUB_ACTOR}"
        git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
        git add .
        git commit -m "build"
        git push
      working-directory: repo
      
    